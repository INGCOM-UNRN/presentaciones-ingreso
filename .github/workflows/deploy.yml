name: Deploy Marp Presentations to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - name: Build
        run: |
          mkdir -p build
          
          # Recolectar todos los archivos CSS que puedan ser temas
          CSS_FILES=$(find . -name "*.css" -not -path "./build/*")
          THEME_ARGS=""
          for css in $CSS_FILES; do
            THEME_ARGS="$THEME_ARGS --theme-set $css"
          done
          
          # Encontrar todos los archivos Markdown con marp: true
          FILES=$(grep -l "marp: true" $(find . -name "*.md" -not -path "./build/*"))
          
          for f in $FILES; do
            echo "Procesando $f..."
            REL_PATH="${f#./}"
            DIR_NAME=$(dirname "$REL_PATH")
            BASE_NAME=$(basename "$REL_PATH" .md)
            
            mkdir -p "build/$DIR_NAME"
            npx @marp-team/marp-cli "$f" $THEME_ARGS --html -o "build/$DIR_NAME/$BASE_NAME.html"
          done
          
          # Generar el índice Markdown
          echo "Generando contenido del índice..."
          cat README.md > build/index_content.md
          echo -e "\n## Índice de Presentaciones\n" >> build/index_content.md
          
          if [ -n "$FILES" ]; then
            rm -f links.tmp
            for f in $FILES; do
              REL_PATH="${f#./}"
              DIR_NAME=$(dirname "$REL_PATH")
              BASE_NAME=$(basename "$REL_PATH" .md)
              HTML_PATH="$DIR_NAME/$BASE_NAME.html"
              HTML_PATH="${HTML_PATH#./}"
              
              TITLE=$(grep "^# " "$f" | head -n 1 | sed 's/# //')
              if [ -z "$TITLE" ]; then TITLE="$BASE_NAME"; fi
              
              echo "$DIR_NAME|$TITLE|$HTML_PATH" >> links.tmp
            done
            
            LAST_DIR=""
            sort links.tmp | while IFS='|' read -r dir title path; do
              if [ "$LAST_DIR" != "$dir" ]; then
                DISPLAY_DIR=$dir
                if [ "$dir" == "." ]; then DISPLAY_DIR="Raíz"; fi
                echo -e "\n### $DISPLAY_DIR\n" >> build/index_content.md
                LAST_DIR="$dir"
              fi
              echo "* [$title]($path)" >> build/index_content.md
            done
            rm -f links.tmp
          fi
          
          # Convertir index_content.md a index.html (HTML simple, no Marp)
          # Usamos pandoc para convertir MD a HTML con el CSS personalizado
          pandoc build/index_content.md -s -c index_style.css -o build/index.html --metadata title="Presentaciones UNRN"
          
          # Copiar assets estáticos al build
          cp index_style.css build/
          for css in $CSS_FILES; do
            REL_CSS="${css#./}"
            mkdir -p "build/$(dirname "$REL_CSS")"
            cp "$css" "build/$REL_CSS"
          done

      - name: Deploy
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: build
          branch: gh-pages
